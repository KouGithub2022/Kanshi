name: WrathCombo 更新監視 (コミット)

permissions:
  contents: write

on:
  schedule:
    - cron: '*/15 * * * *'   # 15分ごと（調整可）
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 最新コミットハッシュ取得 & 前回比較
        id: hash_check
        run: |
          PREV_HASH=""
          [ -f last_hash.txt ] && PREV_HASH=$(cat last_hash.txt)

          LATEST_HASH=$(git ls-remote https://github.com/PunishXIV/WrathCombo.git HEAD | awk '{print $1}')

          echo "prev=$PREV_HASH" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_HASH" >> $GITHUB_OUTPUT

      - name: 更新があればDiscord通知
        if: steps.hash_check.outputs.prev != steps.hash_check.outputs.latest
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "content": "**Questionable 更新検知！**\n最新コミット: ${{ steps.hash_check.outputs.latest }}\nリポジトリ: https://github.com/PunishXIV/WrathCombo\n(前回: ${{ steps.hash_check.outputs.prev || '初回' }})\nチェック時刻: $(date -u +"%Y-%m-%d %H:%M UTC")"
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: ハッシュ更新 & コミット（変更時のみ）
        if: steps.hash_check.outputs.prev != steps.hash_check.outputs.latest
        run: |
          echo "${{ steps.hash_check.outputs.latest }}" > last_hash.txt
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add last_hash.txt
          git commit -m "Update last hash [skip ci]" || echo "No change"
          git push --force origin HEAD:main || echo "Push skipped"
