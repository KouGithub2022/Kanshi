name: RotationSolverReborn æ›´æ–°ç›£è¦– (ã‚³ãƒŸãƒƒãƒˆ)

permissions:
  contents: write

on:
  schedule:
    - cron: '*/15 * * * *'   # 15åˆ†ã”ã¨ï¼ˆé »åº¦é«˜ã„ã®ã§30åˆ†ã«ã—ã¦ã‚‚OKï¼‰
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æœ€æ–°ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥å–å¾— & å‰å›žæ¯”è¼ƒ
        id: hash_check
        run: |
          PREV_HASH=""
          [ -f last_hash.txt ] && PREV_HASH=$(cat last_hash.txt)

          LATEST_HASH=$(git ls-remote https://github.com/FFXIV-CombatReborn/RotationSolverReborn.git HEAD | awk '{print $1}')

          echo "prev=$PREV_HASH" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_HASH" >> $GITHUB_OUTPUT

      - name: æ›´æ–°ãŒã‚ã‚Œã°Discordé€šçŸ¥
        if: steps.hash_check.outputs.prev != steps.hash_check.outputs.latest
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "content": "**RotationSolverReborn æ›´æ–°æ¤œçŸ¥ï¼** ðŸ”¥\næœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: `${{ steps.hash_check.outputs.latest }}`\nãƒªãƒã‚¸ãƒˆãƒª: https://github.com/FFXIV-CombatReborn/RotationSolverReborn\n(å‰å›ž: ${{ steps.hash_check.outputs.prev || 'åˆå›ž' }})\nãƒã‚§ãƒƒã‚¯æ™‚åˆ»: $(date -u +"%Y-%m-%d %H:%M UTC")\nâ†’ ãƒ­ãƒ¼ãƒ†æœ€æ–°ç‰ˆã«æ›´æ–°æŽ¨å¥¨ï¼ æ–°ã‚¸ãƒ§ãƒ–èª¿æ•´å…¥ã£ã¦ã‚‹ã‹ã‚‚ï¼Ÿ"
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: ãƒãƒƒã‚·ãƒ¥æ›´æ–° & ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´æ™‚ã®ã¿ï¼‰
        if: steps.hash_check.outputs.prev != steps.hash_check.outputs.latest
        run: |
          echo "${{ steps.hash_check.outputs.latest }}" > last_hash.txt
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add last_hash.txt
          git commit -m "Update last hash [skip ci]" || echo "No change"
          git push --force origin HEAD:main || echo "Push skipped"
